<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Amadori Basketball</title>
  <script src="js/phaser.min.js"></script>
  <link rel="stylesheet" href="style.css">
  <style>
  body {
    margin: 0px;
    overflow: hidden; /* Prevent scrollbars */
  }
  </style>
</head>
<body>
  <div class="GameContainer" id="game-container"></div>

  <script>
    // Define your desired game dimensions (e.g., a standard mobile aspect ratio)
    var gameWidth = 810;
    var gameHeight = 1080;

    var game = new Phaser.Game(gameWidth, gameHeight, Phaser.CANVAS, 'game-container', {
      preload: preload,
      create: create,
      update: update
    });

    function preload() {
      game.load.image('ball', 'assets/images/ball.png');
      game.load.image('hoop', 'assets/images/hoop.png');
      game.load.image('side rim', 'assets/images/side_rim.png');
      game.load.image('front rim', 'assets/images/front_rim.png');

      for (var i = 0; i <= 4; i++) {
        game.load.image('win' + i, 'assets/images/win' + i + '.png');
        game.load.image('lose' + i, 'assets/images/lose' + i + '.png');
      }

      game.load.audio('score', 'assets/audio/score.wav');
      game.load.audio('backboard', 'assets/audio/backboard.wav');
      game.load.audio('whoosh', 'assets/audio/whoosh.wav');
      game.load.audio('fail', 'assets/audio/fail.wav');
      game.load.audio('spawn', 'assets/audio/spawn.wav');
    }

    var hoop, left_rim, right_rim, ball, front_rim;
    var current_score = 0, current_score_text, high_score = 0, current_best_text, current_best_score_text;
    var score_sound, backboard, whoosh, fail, spawn;
    var moveInTween, fadeInTween, moveOutTween, fadeOutTween, emoji, emojiName;
    var collisionGroup;
    var isDown = false, start_location, end_location, location_interval;

    var scaleFactor = 2;

    function create() {
      game.scale.scaleMode = Phaser.ScaleManager.EXACT_FIT;
      game.scale.pageAlignHorizontally = true;
      game.scale.pageAlignVertically = true;
      game.scale.refresh();

      window.addEventListener('resize', function () {
        game.scale.refresh();
      });

      game.physics.startSystem(Phaser.Physics.P2JS);
      game.physics.p2.setImpactEvents(true);
      game.physics.p2.restitution = 0.63;
      game.physics.p2.gravity.y = 0;
      collisionGroup = game.physics.p2.createCollisionGroup();

      score_sound = game.add.audio('score');
      backboard = game.add.audio('backboard'); backboard.volume = 0.5;
      whoosh = game.add.audio('whoosh');
      fail = game.add.audio('fail'); fail.volume = 0.1;
      spawn = game.add.audio('spawn');

      game.stage.backgroundColor = "#005832";

      // Adjusted hoop position to be higher
      hoop = game.add.sprite(gameWidth / 2, gameHeight * 0.1, 'hoop'); // Moved hoop higher (10% from top)
      hoop.anchor.setTo(0.5, 0);
      hoop.scale.setTo(scaleFactor, scaleFactor);

      left_rim = game.add.sprite(hoop.x - (50 * scaleFactor), hoop.y + (122 * scaleFactor), 'side rim');
      left_rim.anchor.setTo(0.5, 0.5);
      left_rim.scale.setTo(scaleFactor, scaleFactor);

      right_rim = game.add.sprite(hoop.x + (50 * scaleFactor), hoop.y + (122 * scaleFactor), 'side rim');
      right_rim.anchor.setTo(0.5, 0.5);
      right_rim.scale.setTo(scaleFactor, scaleFactor);

      game.physics.p2.enable([left_rim, right_rim], false);
      left_rim.body.setCircle(2.5 * scaleFactor);
      left_rim.body.static = true;
      right_rim.body.setCircle(2.5 * scaleFactor);
      right_rim.body.static = true;

      left_rim.body.setCollisionGroup(collisionGroup);
      right_rim.body.setCollisionGroup(collisionGroup);
      left_rim.body.collides([collisionGroup]);
      right_rim.body.collides([collisionGroup]);

      current_score_text = game.add.text(gameWidth / 2, hoop.y + (250 * scaleFactor), '0', { font: 'Arial', fontSize: (40 * scaleFactor) + 'px', fill: '#FFF', align: 'center' });
      current_score_text.anchor.setTo(0.5, 0.5);

      current_best_text = game.add.text(gameWidth / 2, hoop.y + (200 * scaleFactor), '', { font: 'Arial', fontSize: (20 * scaleFactor) + 'px', fill: '#FFF', align: 'center' });
      current_best_text.anchor.setTo(0.5, 0.5);

      current_best_score_text = game.add.text(gameWidth / 2, hoop.y + (250 * scaleFactor), '', { font: 'Arial', fontSize: (40 * scaleFactor) + 'px', fill: '#00e6e6', align: 'center' });
      current_best_score_text.anchor.setTo(0.5, 0.5);

      createBall();

      cursors = game.input.keyboard.createCursorKeys();
      game.input.onDown.add(click, this);
      game.input.onUp.add(release, this);
    }

    function update() {
      if (ball && ball.body.velocity.y > 0 && !front_rim) {
        front_rim = game.add.sprite(hoop.x - (52 * scaleFactor), hoop.y + (120 * scaleFactor), 'front rim');
        front_rim.scale.setTo(scaleFactor, scaleFactor);
      }
      if (ball && ball.body.velocity.y < 0 && front_rim) {
        front_rim.destroy();
        front_rim = null;
      }

      if (ball && ball.body.velocity.y > 0) {
        ball.body.collides([collisionGroup], hitRim, this);
      }

      // Adjusted scoring threshold to match new hoop position
      if (ball && ball.body.velocity.y > 0 && ball.body.y > (hoop.y + hoop.height * 0.75) && !ball.isBelowHoop) {
        ball.isBelowHoop = true;
        ball.body.collideWorldBounds = false;

        var rand = Math.floor(Math.random() * 5);
        if (ball.body.x > left_rim.x && ball.body.x < right_rim.x) {
          emojiName = "win" + rand;
          current_score += 1;
          current_score_text.text = current_score;
          score_sound.play();
        } else {
          emojiName = "lose" + rand;
          fail.play();
          if (current_score > high_score) high_score = current_score;
          current_score = 0;
          current_score_text.text = '';
          current_best_text.text = 'RECORD';
          current_best_score_text.text = high_score;
        }
        emoji = game.add.sprite(gameWidth / 2, gameHeight * 0.25, emojiName);
        emoji.anchor.setTo(0.5, 0.5);
        emoji.scale.setTo(0.25 * scaleFactor, 0.25 * scaleFactor);
        moveInTween = game.add.tween(emoji).from({ y: emoji.y + (50 * scaleFactor) }, 500, Phaser.Easing.Elastic.Out, true);
        fadeInTween = game.add.tween(emoji).from({ alpha: 0 }, 200, Phaser.Easing.Linear.None, true, 0, 0, false);
        moveInTween.onComplete.add(tweenOut, this);
      }

      if (ball && ball.body.y > gameHeight + (100 * scaleFactor)) {
        game.physics.p2.gravity.y = 0;
        ball.kill();
        createBall();
      }
    }

    function tweenOut() {
      moveOutTween = game.add.tween(emoji).to({ y: emoji.y - (50 * scaleFactor) }, 600, Phaser.Easing.Elastic.In, true);
      moveOutTween.onComplete.add(() => emoji.kill(), this);
      setTimeout(() => {
        fadeOutTween = game.add.tween(emoji).to({ alpha: 0 }, 300, Phaser.Easing.Linear.None, true, 0, 0, false);
      }, 450);
    }

    function hitRim() {
      backboard.play();
    }

    function createBall() {
      var xpos = (current_score === 0) ? gameWidth / 2 : gameWidth * 0.2 + Math.random() * (gameWidth * 0.6);
      spawn.play();
      ball = game.add.sprite(xpos, gameHeight * 0.75, 'ball');
      ball.anchor.setTo(0.5, 0.5);
      game.add.tween(ball.scale).from({ x: 0.7 * scaleFactor, y: 0.7 * scaleFactor }, 100, Phaser.Easing.Linear.None, true);
      game.physics.p2.enable(ball, false);
      ball.body.setCircle(60 * scaleFactor * 0.6);
      ball.launched = false;
      ball.isBelowHoop = false;
    }

    function click(pointer) {
      var bodies = game.physics.p2.hitTest(pointer.position, [ball.body]);
      if (bodies.length) {
        start_location = [pointer.x, pointer.y];
        isDown = true;
        location_interval = setInterval(() => {
          start_location = [pointer.x, pointer.y];
        }, 200);
      }
    }

    function release(pointer) {
      if (isDown) {
        clearInterval(location_interval);
        isDown = false;
        end_location = [pointer.x, pointer.y];
        if (end_location[1] < start_location[1]) {
          var slope = [end_location[0] - start_location[0], end_location[1] - start_location[1]];
          var x_traj = -2300 * scaleFactor * slope[0] / slope[1];
          launch(x_traj);
        }
      }
    }

    function launch(x_traj) {
      if (!ball.launched) {
        ball.body.setCircle(36 * scaleFactor * 0.6);
        ball.body.setCollisionGroup(collisionGroup);
        current_best_text.text = '';
        current_best_score_text.text = '';
        ball.launched = true;
        game.physics.p2.gravity.y = 3000 * scaleFactor;
        game.add.tween(ball.scale).to({ x: 0.6 * scaleFactor, y: 0.6 * scaleFactor }, 500, Phaser.Easing.Linear.None, true);
        ball.body.velocity.x = x_traj;
        ball.body.velocity.y = -1750 * scaleFactor;
        ball.body.rotateRight(x_traj / 3);
        whoosh.play();
      }
    }
  </script>
</body>
</html>